# Alpaca Streaming Integration - Architecture Diagrams

**Document Version:** 1.0
**Date:** October 9, 2025
**Related Documents:**
- ALPACA_STREAMING_REQUIREMENTS_SPECIFICATION.md
- ALPACA_STREAMING_EXECUTIVE_SUMMARY.md

---

## 1. High-Level System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                EXTERNAL SYSTEMS                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚   â”‚  Alpaca WebSocketâ”‚              â”‚ Yahoo Finance APIâ”‚                      â”‚
â”‚   â”‚  wss://stream... â”‚              â”‚   query1.finance â”‚                      â”‚
â”‚   â”‚                  â”‚              â”‚   .yahoo.com     â”‚                      â”‚
â”‚   â”‚  Real-time feed  â”‚              â”‚   REST API       â”‚                      â”‚
â”‚   â”‚  <1s latency     â”‚              â”‚   60s polling    â”‚                      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚            â”‚                                  â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                  â”‚
             â”‚ WSS                              â”‚ HTTPS
             â”‚                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            â”‚         MYTRADER BACKEND         â”‚                                 â”‚
â”‚            â†“                                  â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ AlpacaStreaming     â”‚          â”‚ YahooFinance        â”‚                     â”‚
â”‚  â”‚ Service             â”‚          â”‚ PollingService      â”‚                     â”‚
â”‚  â”‚                     â”‚          â”‚                     â”‚                     â”‚
â”‚  â”‚ - Auth & Connect    â”‚          â”‚ - Poll every 60s    â”‚                     â”‚
â”‚  â”‚ - Subscribe symbols â”‚          â”‚ - Fire events       â”‚                     â”‚
â”‚  â”‚ - Parse messages    â”‚          â”‚ - Write to DB       â”‚                     â”‚
â”‚  â”‚ - Emit events       â”‚          â”‚   (every 5 min)     â”‚                     â”‚
â”‚  â”‚ - Reconnect logic   â”‚          â”‚                     â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚             â”‚                                 â”‚                                 â”‚
â”‚             â”‚ Event: StockPriceUpdated        â”‚ Event: StockPriceUpdated        â”‚
â”‚             â”‚                                 â”‚                                 â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                           â†“                                                     â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚                 â”‚ DataSourceRouter    â”‚                                         â”‚
â”‚                 â”‚                     â”‚                                         â”‚
â”‚                 â”‚ State Machine:      â”‚                                         â”‚
â”‚                 â”‚ - PRIMARY_ACTIVE    â”‚                                         â”‚
â”‚                 â”‚ - FALLBACK_ACTIVE   â”‚                                         â”‚
â”‚                 â”‚ - BOTH_UNAVAILABLE  â”‚                                         â”‚
â”‚                 â”‚                     â”‚                                         â”‚
â”‚                 â”‚ Logic:              â”‚                                         â”‚
â”‚                 â”‚ - Route primary     â”‚                                         â”‚
â”‚                 â”‚ - Detect failures   â”‚                                         â”‚
â”‚                 â”‚ - Switch fallback   â”‚                                         â”‚
â”‚                 â”‚ - Recover primary   â”‚                                         â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                            â”‚                                                    â”‚
â”‚                            â”‚ Event: StockPriceUpdated (with Source metadata)   â”‚
â”‚                            â†“                                                    â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚                 â”‚ MultiAssetData      â”‚                                         â”‚
â”‚                 â”‚ BroadcastService    â”‚                                         â”‚
â”‚                 â”‚                     â”‚                                         â”‚
â”‚                 â”‚ - Throttle updates  â”‚                                         â”‚
â”‚                 â”‚ - Add metadata      â”‚                                         â”‚
â”‚                 â”‚ - Format messages   â”‚                                         â”‚
â”‚                 â”‚ - Broadcast groups  â”‚                                         â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                            â”‚                                                    â”‚
â”‚                            â”‚ SignalR SendAsync                                  â”‚
â”‚                            â†“                                                    â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚           â”‚   SignalR Hubs                     â”‚                               â”‚
â”‚           â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                               â”‚
â”‚           â”‚   â”‚MarketDataHub â”‚ â”‚DashboardHub â”‚â”‚                               â”‚
â”‚           â”‚   â”‚              â”‚ â”‚             â”‚â”‚                               â”‚
â”‚           â”‚   â”‚Groups:       â”‚ â”‚Groups:      â”‚â”‚                               â”‚
â”‚           â”‚   â”‚STOCK_AAPL    â”‚ â”‚AssetClass_  â”‚â”‚                               â”‚
â”‚           â”‚   â”‚STOCK_GOOGL   â”‚ â”‚STOCK        â”‚â”‚                               â”‚
â”‚           â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                               â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                            â”‚                                                    â”‚
â”‚                            â”‚ WebSocket (SignalR protocol)                      â”‚
â”‚                            â†“                                                    â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚                   â”‚ PostgreSQL DB   â”‚                                          â”‚
â”‚                   â”‚                 â”‚                                          â”‚
â”‚                   â”‚ market_data     â”‚                                          â”‚
â”‚                   â”‚ table           â”‚                                          â”‚
â”‚                   â”‚                 â”‚                                          â”‚
â”‚                   â”‚ (5-min writes)  â”‚                                          â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ WebSocket (SignalR)
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              FRONTEND CLIENTS                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚   â”‚  React Web App   â”‚              â”‚ React Native App â”‚                      â”‚
â”‚   â”‚                  â”‚              â”‚                  â”‚                      â”‚
â”‚   â”‚  - Dashboard     â”‚              â”‚  - Dashboard     â”‚                      â”‚
â”‚   â”‚  - Portfolio     â”‚              â”‚  - Portfolio     â”‚                      â”‚
â”‚   â”‚  - Strategies    â”‚              â”‚  - Strategies    â”‚                      â”‚
â”‚   â”‚                  â”‚              â”‚                  â”‚                      â”‚
â”‚   â”‚  Display:        â”‚              â”‚  Display:        â”‚                      â”‚
â”‚   â”‚  $150.25 +0.5%   â”‚              â”‚  $150.25 +0.5%   â”‚                      â”‚
â”‚   â”‚  Badge: LIVE     â”‚              â”‚  Badge: LIVE     â”‚                      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Data Flow - Normal Operation (Alpaca Primary)

```
TIME: T+0s (Market Event)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NASDAQ Exchange: AAPL traded @ $150.25  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ Market feed
                   â†“
TIME: T+0.1s
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Alpaca WebSocket Server                 â”‚
â”‚ - Aggregates exchange feeds             â”‚
â”‚ - Broadcasts to subscribers             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ WSS message: {"T":"t","S":"AAPL","p":150.25,...}
                   â†“
TIME: T+0.3s
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AlpacaStreamingService                  â”‚
â”‚ 1. Receive WebSocket message            â”‚
â”‚ 2. Parse JSON                           â”‚
â”‚ 3. Extract: Symbol=AAPL, Price=150.25   â”‚
â”‚ 4. Calculate:                           â”‚
â”‚    - PriceChange = 150.25 - 150.00 = 0.25
â”‚    - PriceChangePercent = 0.17%        â”‚
â”‚ 5. Create StockPriceData object         â”‚
â”‚ 6. Emit event: StockPriceUpdated        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ Event: StockPriceData { Symbol=AAPL, Price=150.25, Source=ALPACA }
                   â†“
TIME: T+0.4s
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DataSourceRouter                        â”‚
â”‚ 1. Receive event from Alpaca            â”‚
â”‚ 2. Check current state: PRIMARY_ACTIVE  â”‚
â”‚ 3. Decision: Forward event              â”‚
â”‚ 4. Log: "Routing AAPL from ALPACA"      â”‚
â”‚ 5. Forward to MultiAssetDataBroadcast   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ Event: StockPriceData (unchanged)
                   â†“
TIME: T+0.5s
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MultiAssetDataBroadcastService          â”‚
â”‚ 1. Receive event                        â”‚
â”‚ 2. Check throttle (last update >50ms?)  â”‚
â”‚ 3. Convert to MultiAssetPriceUpdate:    â”‚
â”‚    {                                    â”‚
â”‚      Type: "PriceUpdate",               â”‚
â”‚      AssetClass: "STOCK",               â”‚
â”‚      Symbol: "AAPL",                    â”‚
â”‚      Price: 150.25,                     â”‚
â”‚      Change24h: 0.17,                   â”‚
â”‚      Source: "ALPACA",                  â”‚
â”‚      Timestamp: "2025-10-09T14:30:00Z"  â”‚
â”‚    }                                    â”‚
â”‚ 4. Broadcast to SignalR groups:         â”‚
â”‚    - Group: "STOCK_AAPL"                â”‚
â”‚    - Group: "AssetClass_STOCK"          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ SignalR: SendAsync("PriceUpdate", data)
                   â†“
TIME: T+0.7s
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MarketDataHub / DashboardHub            â”‚
â”‚ 1. Receive broadcast request            â”‚
â”‚ 2. Find clients in group "STOCK_AAPL"   â”‚
â”‚ 3. Send to 25 connected clients         â”‚
â”‚ 4. Find clients in group "AssetClass_   â”‚
â”‚    STOCK"                               â”‚
â”‚ 5. Send to 50 connected clients         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ WebSocket frames (SignalR protocol)
                   â†“
TIME: T+1.0s
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend Clients (React/React Native)   â”‚
â”‚ 1. Receive SignalR message              â”‚
â”‚ 2. Parse PriceUpdate                    â”‚
â”‚ 3. Update state: setPrice(150.25)       â”‚
â”‚ 4. Re-render component:                 â”‚
â”‚    <PriceDisplay                        â”‚
â”‚      price={150.25}                     â”‚
â”‚      change={+0.17}                     â”‚
â”‚      badge="LIVE"                       â”‚
â”‚      color="green"                      â”‚
â”‚    />                                   â”‚
â”‚ 5. User sees updated price              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TOTAL LATENCY: ~1.0 second (market event â†’ user screen)
```

---

## 3. Data Flow - Fallback Scenario (Alpaca Failed)

```
TIME: T+0s (Alpaca Disconnects)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Alpaca WebSocket Server                 â”‚
â”‚ âœ— Connection lost (network issue)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ No messages received
                   â†“
TIME: T+30s (Timeout detected)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AlpacaStreamingService                  â”‚
â”‚ 1. Detect: No messages for 30 seconds   â”‚
â”‚ 2. Health check fails                   â”‚
â”‚ 3. Status: DISCONNECTED                 â”‚
â”‚ 4. Attempt reconnection (backoff)       â”‚
â”‚ 5. Log: "Alpaca connection lost"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ No events emitted
                   â†“
TIME: T+35s (Fallback triggered)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DataSourceRouter                        â”‚
â”‚ 1. Detect: 3 consecutive Alpaca failuresâ”‚
â”‚ 2. Decision: ACTIVATE FALLBACK          â”‚
â”‚ 3. State transition:                    â”‚
â”‚    PRIMARY_ACTIVE â†’ FALLBACK_ACTIVE     â”‚
â”‚ 4. Log: "Switching to Yahoo fallback"   â”‚
â”‚ 5. Send notification to frontend        â”‚
â”‚ 6. Start forwarding Yahoo events        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ Notification: { type: "DataSourceChange", source: "YAHOO_FALLBACK" }
                   â†“
TIME: T+36s
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend Clients                        â”‚
â”‚ 1. Receive notification                 â”‚
â”‚ 2. Display yellow badge: "DELAYED"      â”‚
â”‚ 3. Show toast: "Real-time data          â”‚
â”‚    temporarily unavailable, using       â”‚
â”‚    delayed data"                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TIME: T+60s (Yahoo polling cycle)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Yahoo Finance API                       â”‚
â”‚ GET /v8/finance/chart/AAPL              â”‚
â”‚ Response: { regularMarketPrice: 150.30 }â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ HTTP response
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ YahooFinancePollingService              â”‚
â”‚ 1. Parse response                       â”‚
â”‚ 2. Calculate price change               â”‚
â”‚ 3. Create StockPriceData object         â”‚
â”‚    Source: "YAHOO_FALLBACK"             â”‚
â”‚ 4. Emit event: StockPriceUpdated        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ Event: StockPriceData { Symbol=AAPL, Price=150.30, Source=YAHOO_FALLBACK }
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DataSourceRouter                        â”‚
â”‚ 1. Receive event from Yahoo             â”‚
â”‚ 2. Check state: FALLBACK_ACTIVE         â”‚
â”‚ 3. Decision: Forward event              â”‚
â”‚ 4. Log: "Routing AAPL from YAHOO"       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ â†’ MultiAssetDataBroadcast â†’ SignalR â†’ Frontend
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend Clients                        â”‚
â”‚ Display:                                â”‚
â”‚ $150.30 +0.37%                          â”‚
â”‚ Badge: DELAYED (yellow)                 â”‚
â”‚ Last updated: 1 minute ago              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FALLBACK LATENCY: ~60 seconds (polling interval)
```

---

## 4. Data Flow - Recovery Scenario (Alpaca Restored)

```
TIME: T+0s (Alpaca reconnects)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AlpacaStreamingService                  â”‚
â”‚ 1. Reconnection attempt succeeds        â”‚
â”‚ 2. Send auth message                    â”‚
â”‚ 3. Receive auth success                 â”‚
â”‚ 4. Subscribe to symbols                 â”‚
â”‚ 5. Start receiving messages             â”‚
â”‚ 6. Status: CONNECTED                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ Event: StockPriceUpdated (ALPACA source)
                   â†“
TIME: T+5s (Messages flowing)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DataSourceRouter                        â”‚
â”‚ 1. Receive Alpaca events                â”‚
â”‚ 2. Check state: FALLBACK_ACTIVE         â”‚
â”‚ 3. Decision: WAIT (grace period)        â”‚
â”‚ 4. Validate message rate: OK            â”‚
â”‚ 5. Validate message quality: OK         â”‚
â”‚ 6. Timer: Grace period 10 seconds       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ (Still forwarding Yahoo events during grace period)
                   â†“
TIME: T+15s (Grace period elapsed)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DataSourceRouter                        â”‚
â”‚ 1. Grace period complete                â”‚
â”‚ 2. Alpaca validated: Stable             â”‚
â”‚ 3. Decision: RECOVER PRIMARY            â”‚
â”‚ 4. State transition:                    â”‚
â”‚    FALLBACK_ACTIVE â†’ PRIMARY_ACTIVE     â”‚
â”‚ 5. Log: "Recovering to Alpaca primary"  â”‚
â”‚ 6. Send notification to frontend        â”‚
â”‚ 7. Stop forwarding Yahoo events         â”‚
â”‚ 8. Resume forwarding Alpaca events      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ Notification: { type: "DataSourceChange", source: "ALPACA" }
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend Clients                        â”‚
â”‚ 1. Receive notification                 â”‚
â”‚ 2. Display green badge: "LIVE"          â”‚
â”‚ 3. Show toast: "Real-time data restored"â”‚
â”‚ 4. Resume <1s price updates             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RECOVERY TIME: ~15 seconds (including 10s grace period)
```

---

## 5. State Machine Diagram (DataSourceRouter)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         STATE MACHINE: DataSourceRouter                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚ STARTUP  â”‚
                                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                 â”‚
          Alpaca connects                     Alpaca fails to connect
          & authenticated                     (after 30s timeout)
                    â”‚                                 â”‚
                    â†“                                 â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  PRIMARY_ACTIVE      â”‚          â”‚  FALLBACK_ACTIVE     â”‚
         â”‚                      â”‚          â”‚                      â”‚
         â”‚  Actions:            â”‚          â”‚  Actions:            â”‚
         â”‚  - Forward Alpaca    â”‚          â”‚  - Forward Yahoo     â”‚
         â”‚  - Ignore Yahoo      â”‚          â”‚  - Show warning      â”‚
         â”‚  - Health check      â”‚          â”‚  - Retry Alpaca      â”‚
         â”‚  - Monitor latency   â”‚          â”‚  - Monitor recovery  â”‚
         â”‚                      â”‚          â”‚                      â”‚
         â”‚  Display:            â”‚          â”‚  Display:            â”‚
         â”‚  Badge: LIVE (green) â”‚          â”‚  Badge: DELAYED (âš ï¸) â”‚
         â”‚  Latency: <1s        â”‚          â”‚  Latency: 60s        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                                  â”‚
                    â”‚                                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                      â”‚           â”‚                       â”‚
  Alpaca failure:        Yahoo still  Alpaca recovers         Alpaca still
  - Connection lost      working          & validated         disconnected
  - 30s silence                           + grace period
  - 3 consecutive                         (10s)
    health check fails                                â”‚
        â”‚                      â”‚           â”‚                       â”‚
        â”‚                      â”‚           â”‚                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                                   â”‚
                   â”‚                                   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚       â”‚
                               â†“       â†‘
                               â”‚       â”‚
                               â”‚  Recovery
                               â”‚  with grace
                               â”‚
                Both sources    â”‚
                fail            â”‚
                               â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ BOTH_UNAVAILABLE     â”‚
                    â”‚                      â”‚
                    â”‚ Actions:             â”‚
                    â”‚ - Show error         â”‚
                    â”‚ - Cache last values  â”‚
                    â”‚ - Display stale data â”‚
                    â”‚ - Retry both sources â”‚
                    â”‚ - Alert operations   â”‚
                    â”‚                      â”‚
                    â”‚ Display:             â”‚
                    â”‚ Badge: ERROR (ğŸ”´)    â”‚
                    â”‚ Message: "Data       â”‚
                    â”‚  temporarily         â”‚
                    â”‚  unavailable"        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ Any source recovers
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                      â”‚
              Alpaca recovers        Yahoo recovers
                    â”‚                      â”‚
                    â†“                      â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  PRIMARY_ACTIVE      â”‚  â”‚  FALLBACK_ACTIVE     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


STATE TRANSITION CONDITIONS:

STARTUP â†’ PRIMARY_ACTIVE:
  - Alpaca connects successfully
  - Authentication succeeds within 10s
  - Subscription confirmed

STARTUP â†’ FALLBACK_ACTIVE:
  - Alpaca fails to connect after 30s timeout
  - OR authentication fails

PRIMARY_ACTIVE â†’ FALLBACK_ACTIVE:
  - Alpaca connection lost for >10 seconds
  - OR no messages received for >30 seconds
  - OR 3 consecutive health check failures
  - AND Yahoo is available

FALLBACK_ACTIVE â†’ PRIMARY_ACTIVE:
  - Alpaca connection restored
  - AND authentication succeeds
  - AND subscription confirmed
  - AND at least 1 message received successfully
  - AND 10-second grace period elapsed

PRIMARY_ACTIVE â†’ BOTH_UNAVAILABLE:
  - Alpaca fails AND Yahoo fails

FALLBACK_ACTIVE â†’ BOTH_UNAVAILABLE:
  - Yahoo fails (Alpaca already failed)

BOTH_UNAVAILABLE â†’ PRIMARY_ACTIVE:
  - Alpaca recovers (preferred path)

BOTH_UNAVAILABLE â†’ FALLBACK_ACTIVE:
  - Yahoo recovers (Alpaca still down)
```

---

## 6. Sequence Diagram - Alpaca Subscription Flow

```
Client               AlpacaStreaming    Alpaca        Database    DataSource
(App Start)          Service            WebSocket     (PostgreSQL) Router
   â”‚                      â”‚                  â”‚              â”‚          â”‚
   â”‚â”€â”€Start Serviceâ”€â”€â”€â”€â”€â”€>â”‚                  â”‚              â”‚          â”‚
   â”‚                      â”‚                  â”‚              â”‚          â”‚
   â”‚                      â”‚â”€â”€Load Symbolsâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>      â”‚          â”‚
   â”‚                      â”‚  (SELECT ticker FROM symbols    â”‚          â”‚
   â”‚                      â”‚   WHERE asset_class='STOCK'     â”‚          â”‚
   â”‚                      â”‚   AND is_active=true LIMIT 30)  â”‚          â”‚
   â”‚                      â”‚                  â”‚              â”‚          â”‚
   â”‚                      â”‚<â”€â”€â”€â”€â”€Return Symbolsâ”€â”€â”€â”€â”€â”€â”€â”€     â”‚          â”‚
   â”‚                      â”‚  [AAPL, GOOGL, MSFT, ...]       â”‚          â”‚
   â”‚                      â”‚                  â”‚              â”‚          â”‚
   â”‚                      â”‚â”€â”€Connect WSSâ”€â”€â”€â”€>â”‚              â”‚          â”‚
   â”‚                      â”‚                  â”‚              â”‚          â”‚
   â”‚                      â”‚<â”€â”€â”€Connectedâ”€â”€â”€â”€â”€â”‚              â”‚          â”‚
   â”‚                      â”‚                  â”‚              â”‚          â”‚
   â”‚                      â”‚â”€â”€Auth Messageâ”€â”€â”€â”€>              â”‚          â”‚
   â”‚                      â”‚  {action: "auth",â”‚              â”‚          â”‚
   â”‚                      â”‚   key: "***",    â”‚              â”‚          â”‚
   â”‚                      â”‚   secret: "***"} â”‚              â”‚          â”‚
   â”‚                      â”‚                  â”‚              â”‚          â”‚
   â”‚                      â”‚<â”€â”€â”€Auth Successâ”€â”€â”‚              â”‚          â”‚
   â”‚                      â”‚  {T:"success",   â”‚              â”‚          â”‚
   â”‚                      â”‚   msg:"auth'd"}  â”‚              â”‚          â”‚
   â”‚                      â”‚                  â”‚              â”‚          â”‚
   â”‚                      â”‚â”€â”€Subscribeâ”€â”€â”€â”€â”€â”€â”€>              â”‚          â”‚
   â”‚                      â”‚  {action: "sub", â”‚              â”‚          â”‚
   â”‚                      â”‚   trades: [...], â”‚              â”‚          â”‚
   â”‚                      â”‚   quotes: [...]} â”‚              â”‚          â”‚
   â”‚                      â”‚                  â”‚              â”‚          â”‚
   â”‚                      â”‚<â”€â”€â”€Sub Confirmedâ”€â”‚              â”‚          â”‚
   â”‚                      â”‚  {T:"subscriptionâ”‚              â”‚          â”‚
   â”‚                      â”‚   trades:[...]}  â”‚              â”‚          â”‚
   â”‚                      â”‚                  â”‚              â”‚          â”‚
   â”‚                      â”‚â”€â”€Register Routerâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚
   â”‚                      â”‚  (Subscribe to   â”‚              â”‚          â”‚
   â”‚                      â”‚   StockPriceUpdated event)      â”‚          â”‚
   â”‚                      â”‚                  â”‚              â”‚          â”‚
   â”‚<â”€Service Readyâ”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚              â”‚          â”‚
   â”‚                      â”‚                  â”‚              â”‚          â”‚
   â”‚                      â”‚                  â”‚              â”‚          â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ NORMAL OPERATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                      â”‚                  â”‚              â”‚          â”‚
   â”‚                      â”‚<â”€â”€â”€Trade Msgâ”€â”€â”€â”€â”€â”‚              â”‚          â”‚
   â”‚                      â”‚  {T:"t",S:"AAPL",â”‚              â”‚          â”‚
   â”‚                      â”‚   p:150.25,...}  â”‚              â”‚          â”‚
   â”‚                      â”‚                  â”‚              â”‚          â”‚
   â”‚                      â”‚â”€â”€Parse & Emitâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                      â”‚  StockPriceUpdated(Symbol=AAPL,Price=...)â”‚
   â”‚                      â”‚                  â”‚              â”‚          â”‚
   â”‚                      â”‚                  â”‚              â”‚<â”€Routeâ”€â”€â”€â”‚
   â”‚                      â”‚                  â”‚              â”‚  (Forward â”‚
   â”‚                      â”‚                  â”‚              â”‚   event)  â”‚
   â”‚                      â”‚                  â”‚              â”‚          â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Price Update Broadcast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚  (via SignalR)       â”‚                  â”‚              â”‚          â”‚
   â”‚                      â”‚                  â”‚              â”‚          â”‚
```

---

## 7. Component Interaction Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       COMPONENT INTERACTIONS                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AlpacaStreaming      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service              â”‚                   â”‚
â”‚                      â”‚                   â”‚ Subscribe to
â”‚ Responsibilities:    â”‚                   â”‚ events
â”‚ - WebSocket mgmt     â”‚                   â”‚
â”‚ - Auth & reconnect   â”‚                   â†“
â”‚ - Parse messages     â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ - Emit events        â”‚         â”‚ DataSourceRouter     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚                      â”‚
           â”‚                     â”‚ Responsibilities:    â”‚
           â”‚ Event:              â”‚ - Route events       â”‚
           â”‚ StockPriceUpdated   â”‚ - State machine      â”‚
           â”‚ (Source=ALPACA)     â”‚ - Health monitoring  â”‚
           â”‚                     â”‚ - Fallback logic     â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â”‚ Event:
                                            â”‚ StockPriceUpdated
                                            â”‚ (with routing
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚  decision)
â”‚ YahooFinance         â”‚                   â”‚
â”‚ PollingService       â”‚                   â”‚
â”‚                      â”‚                   â”‚
â”‚ Responsibilities:    â”‚                   â”‚
â”‚ - Poll REST API      â”‚                   â”‚
â”‚ - Write to DB        â”‚                   â†“
â”‚ - Emit events        â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ MultiAssetData       â”‚
           â”‚                     â”‚ BroadcastService     â”‚
           â”‚ Event:              â”‚                      â”‚
           â”‚ StockPriceUpdated   â”‚ Responsibilities:    â”‚
           â”‚ (Source=YAHOO)      â”‚ - Throttle updates   â”‚
           â”‚                     â”‚ - Format messages    â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ - SignalR broadcast  â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â”‚ SignalR
                                            â”‚ SendAsync()
                                            â”‚
                                            â†“
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ SignalR Hubs                    â”‚
                         â”‚ (MarketDataHub, DashboardHub)   â”‚
                         â”‚                                 â”‚
                         â”‚ Responsibilities:               â”‚
                         â”‚ - Manage connections            â”‚
                         â”‚ - Manage groups                 â”‚
                         â”‚ - Send to clients               â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â”‚ WebSocket
                                            â”‚ frames
                                            â†“
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ Frontend Clients                â”‚
                         â”‚ (React Web, React Native)       â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


DEPENDENCY DIAGRAM:

AlpacaStreamingService
  â†“ depends on
  - Alpaca WebSocket API (external)
  - ISymbolManagementService (database access)
  - ILogger

DataSourceRouter
  â†“ depends on
  - AlpacaStreamingService (events)
  - YahooFinancePollingService (events)
  - ILogger

MultiAssetDataBroadcastService
  â†“ depends on
  - DataSourceRouter (events)
  - IHubContext<DashboardHub>
  - IHubContext<MarketDataHub>
  - ILogger

YahooFinancePollingService
  â†“ depends on
  - Yahoo Finance API (external)
  - ITradingDbContext (database)
  - ILogger
```

---

## 8. Database Interaction Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DATABASE OPERATIONS                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

READ OPERATIONS (Symbol Loading):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AlpacaStreaming      â”‚
â”‚ Service              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ On Startup & Every 5 minutes:
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SELECT ticker, venue                                             â”‚
â”‚ FROM symbols                                                     â”‚
â”‚ WHERE asset_class = 'STOCK'                                      â”‚
â”‚   AND is_active = true                                           â”‚
â”‚   AND is_tracked = true                                          â”‚
â”‚ ORDER BY                                                         â”‚
â”‚   CASE WHEN ticker IN (SELECT symbol FROM portfolio_positions    â”‚
â”‚                        WHERE user_id = @current_user)            â”‚
â”‚        THEN 1                                                    â”‚
â”‚        WHEN is_popular = true THEN 2                             â”‚
â”‚        ELSE 3                                                    â”‚
â”‚   END,                                                           â”‚
â”‚   volume_24h DESC                                                â”‚
â”‚ LIMIT 30;  -- Alpaca free tier limit                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Returns: [AAPL, GOOGL, MSFT, ...]
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Subscribe to symbols â”‚
â”‚ via Alpaca WebSocket â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


WRITE OPERATIONS (Persistence):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ YahooFinance         â”‚
â”‚ PollingService       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Every 5 minutes:
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ INSERT INTO market_data (                                        â”‚
â”‚   id,                                                            â”‚
â”‚   symbol,                                                        â”‚
â”‚   timeframe,                                                     â”‚
â”‚   timestamp,                                                     â”‚
â”‚   open,                                                          â”‚
â”‚   high,                                                          â”‚
â”‚   low,                                                           â”‚
â”‚   close,                                                         â”‚
â”‚   volume,                                                        â”‚
â”‚   asset_class                                                    â”‚
â”‚ ) VALUES (                                                       â”‚
â”‚   gen_random_uuid(),                                             â”‚
â”‚   'AAPL',                                                        â”‚
â”‚   '5MIN',                                                        â”‚
â”‚   NOW(),                                                         â”‚
â”‚   150.10,  -- open = current price                              â”‚
â”‚   150.25,  -- high = current price                              â”‚
â”‚   150.05,  -- low = current price                               â”‚
â”‚   150.20,  -- close = current price                             â”‚
â”‚   1000000, -- volume from API                                    â”‚
â”‚   'STOCK'                                                        â”‚
â”‚ )                                                                â”‚
â”‚ ON CONFLICT (symbol, timeframe, timestamp) DO UPDATE             â”‚
â”‚ SET close = EXCLUDED.close,                                      â”‚
â”‚     high = GREATEST(market_data.high, EXCLUDED.high),            â”‚
â”‚     low = LEAST(market_data.low, EXCLUDED.low),                  â”‚
â”‚     volume = EXCLUDED.volume;                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


INDEX USAGE:

market_data table has index:
  idx_market_data_symbol_timeframe_timestamp (symbol, timeframe, timestamp)

This supports efficient queries for:
  - Historical data retrieval (backtesting)
  - Chart data generation
  - Performance analysis
```

---

## 9. Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ERROR SCENARIOS & HANDLING                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SCENARIO 1: Alpaca Authentication Failure
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AlpacaStreaming      â”‚
â”‚ Service              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 1. Connect to WebSocket
           â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Alpaca  â”‚
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 2. Send auth {key, secret}
           â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Alpaca  â”‚
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 3. Response: {T:"error", code:401, msg:"unauthorized"}
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AlpacaStreaming      â”‚
â”‚ Service              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 4. Catch error
           â”‚ 5. Log: "Alpaca auth failed: unauthorized"
           â”‚ 6. Retry with backoff (1s, 2s, 4s, 8s, ...)
           â”‚ 7. After 5 failures: Alert operations
           â”‚ 8. Status: DISCONNECTED
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DataSourceRouter     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 9. Detect: Alpaca unavailable
           â”‚ 10. Transition: STARTUP â†’ FALLBACK_ACTIVE
           â”‚ 11. Use Yahoo as primary source
           â†“
     (Continue with Yahoo)


SCENARIO 2: Message Timeout (30s no data)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AlpacaStreaming      â”‚
â”‚ Service              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Last message: T+0s
           â”‚ Current time: T+30s
           â”‚
           â”‚ 1. Timer expires: MessageTimeoutSeconds = 30
           â”‚ 2. Health check fails
           â”‚ 3. Log: "Alpaca message timeout (30s)"
           â”‚ 4. Status: STALE
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DataSourceRouter     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 5. Detect: Stale data
           â”‚ 6. Decision: Switch to fallback
           â”‚ 7. Transition: PRIMARY_ACTIVE â†’ FALLBACK_ACTIVE
           â†“
     (Yahoo takes over)


SCENARIO 3: Invalid Message (Parse Error)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Alpaca WebSocket     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Message: {T:"t",S:"AAPL",p:"invalid",...}
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AlpacaStreaming      â”‚
â”‚ Service              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 1. Try: Parse JSON
           â”‚ 2. Try: Extract price field
           â”‚ 3. Catch: FormatException (price not numeric)
           â”‚ 4. Log warning: "Failed to parse AAPL price: invalid"
           â”‚ 5. Skip this message
           â”‚ 6. Continue processing next message
           â”‚ 7. Do NOT trigger fallback (transient error)
           â†“
     (Continue normal operation)


SCENARIO 4: Both Sources Fail
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AlpacaStreaming      â”‚  â”‚ YahooFinance         â”‚
â”‚ Service              â”‚  â”‚ PollingService       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                         â”‚
           â”‚ Disconnected            â”‚ HTTP 503 Service Unavailable
           â†“                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DataSourceRouter                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 1. Detect: Both sources unavailable
           â”‚ 2. Transition: â†’ BOTH_UNAVAILABLE
           â”‚ 3. Log critical: "All market data sources failed"
           â”‚ 4. Alert operations (PagerDuty)
           â”‚ 5. Actions:
           â”‚    - Serve cached data (last 100 updates per symbol)
           â”‚    - Display error badge: "Data unavailable"
           â”‚    - Show staleness: "Last updated: 5 minutes ago"
           â”‚    - Continue retry attempts for both sources
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend Clients     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Display:
           â”‚ - Red badge: "ERROR"
           â”‚ - Message: "Market data temporarily unavailable"
           â”‚ - Show cached prices with timestamp
           â”‚ - Disable trading actions
           â†“
     (Wait for source recovery)
```

---

## 10. Monitoring Dashboard Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ALPACA STREAMING DASHBOARD                            â”‚
â”‚                   (Grafana / Application Insights)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONNECTION STATUS                   â”‚ PERFORMANCE METRICS              â”‚
â”‚                                     â”‚                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Current State: PRIMARY_ACTIVE   â”‚ â”‚ â”‚ P50 Latency: 0.8s           â”‚ â”‚
â”‚ â”‚ â— Connected                     â”‚ â”‚ â”‚ P95 Latency: 1.5s           â”‚ â”‚
â”‚ â”‚                                 â”‚ â”‚ â”‚ P99 Latency: 2.3s           â”‚ â”‚
â”‚ â”‚ Alpaca: âœ… Healthy              â”‚ â”‚ â”‚                             â”‚ â”‚
â”‚ â”‚ Yahoo:  âœ… Healthy              â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚                                 â”‚ â”‚ â”‚ â”‚  Latency Chart       â”‚   â”‚ â”‚
â”‚ â”‚ Last Message: 2s ago            â”‚ â”‚ â”‚ â”‚  (last 1 hour)       â”‚   â”‚ â”‚
â”‚ â”‚ Messages/min: 120               â”‚ â”‚ â”‚ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚   â”‚ â”‚
â”‚ â”‚ Uptime: 99.8%                   â”‚ â”‚ â”‚ â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚                                     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MESSAGE THROUGHPUT                  â”‚ ERROR METRICS                    â”‚
â”‚                                     â”‚                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚ â”‚ Total Errors: 5             â”‚ â”‚
â”‚ â”‚ â”‚ Messages/sec Chart        â”‚   â”‚ â”‚ â”‚ Error Rate: 0.01%           â”‚ â”‚
â”‚ â”‚ â”‚ (last 15 minutes)         â”‚   â”‚ â”‚ â”‚                             â”‚ â”‚
â”‚ â”‚ â”‚                          â”‚   â”‚ â”‚ â”‚ By Type:                    â”‚ â”‚
â”‚ â”‚ â”‚   â–‚â–ƒâ–…â–†â–‡â–ˆâ–‡â–†â–…â–ƒâ–‚           â”‚   â”‚ â”‚ â”‚ - Parse errors: 2           â”‚ â”‚
â”‚ â”‚ â”‚                          â”‚   â”‚ â”‚ â”‚ - Timeout errors: 1         â”‚ â”‚
â”‚ â”‚ â”‚ Current: 2.3 msg/sec     â”‚   â”‚ â”‚ â”‚ - Auth errors: 0            â”‚ â”‚
â”‚ â”‚ â”‚ Peak: 5.1 msg/sec        â”‚   â”‚ â”‚ â”‚ - Connection errors: 2      â”‚ â”‚
â”‚ â”‚ â”‚ Average: 2.0 msg/sec     â”‚   â”‚ â”‚ â”‚                             â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FALLBACK HISTORY                    â”‚ SYMBOL DISTRIBUTION              â”‚
â”‚                                     â”‚                                  â”‚
â”‚ Last 24 hours:                      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ - Fallback activations: 2           â”‚ â”‚ Active Symbols: 25/30       â”‚ â”‚
â”‚ - Total fallback time: 15 min       â”‚ â”‚                             â”‚ â”‚
â”‚ - Average recovery: 12s             â”‚ â”‚ Top by message count:       â”‚ â”‚
â”‚                                     â”‚ â”‚ 1. AAPL:  150 msg/min       â”‚ â”‚
â”‚ Timeline:                           â”‚ â”‚ 2. GOOGL: 145 msg/min       â”‚ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ 3. MSFT:  140 msg/min       â”‚ â”‚
â”‚ â”‚ 08:00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚ â”‚ â”‚ 4. TSLA:  138 msg/min       â”‚ â”‚
â”‚ â”‚ 10:30 â”€â”€â”€âš ï¸â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚ â”‚ â”‚ 5. AMZN:  135 msg/min       â”‚ â”‚
â”‚ â”‚       (Fallback 8 min)          â”‚ â”‚ â”‚                             â”‚ â”‚
â”‚ â”‚ 14:15 â”€â”€â”€â”€â”€â”€âš ï¸â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚       (Fallback 7 min)          â”‚ â”‚                                  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ALERTS (Last 24 hours)                                                   â”‚
â”‚                                                                          â”‚
â”‚ âš ï¸ 14:15 - Alpaca connection lost, switched to fallback (Resolved: 14:22)â”‚
â”‚ âš ï¸ 10:30 - High latency detected (P95: 3.2s) (Resolved: 10:38)          â”‚
â”‚ â„¹ï¸  08:00 - Alpaca connection restored from overnight maintenance       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**End of Architecture Diagrams Document**

These diagrams provide a comprehensive visual representation of the Alpaca streaming integration architecture. Use them in design reviews, implementation planning, and team onboarding.
